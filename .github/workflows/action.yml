name: Publish and Deploy Docker Image

on:
  push:
    branches:
      - main

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.actor }}/tsb-service:latest

jobs:
  build_and_publish:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.PAT }}" | docker login ${{ env.DOCKER_REGISTRY }} -u ${{ github.actor }} --password-stdin

    - name: Build and Push Multi-Arch Docker Image
      run: |
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --tag ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} \
          --push \
          .

  deploy:
    needs: build_and_publish
    name: Deploy to Home Server
    runs-on: ubuntu-latest

    steps:
      - name: Trigger deploy webhook
        run: |
          curl -X POST ${{ vars.DEPLOY_WEBHOOK_URL }} \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            --fail --max-time 300